"use strict";var Map=function(t){var e=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"),n=L.tileLayer("http://{s}.tile.opencyclemap.org/cycle/{z}/{x}/{y}.png"),i=L.tileLayer("http://{s}.tile2.opencyclemap.org/transport/{z}/{x}/{y}.png"),a=L.tileLayer("http://{s}.tile.stamen.com/toner/{z}/{x}/{y}.png"),o=L.tileLayer("http://{s}.tile.stamen.com/watercolor/{z}/{x}/{y}.jpg");this.buildingTypes=[{name:"Pillar",layerName:"Pillars",icon:"stop_available"},{name:"Arena",layerName:"Arenas",icon:"arena"},{name:"Obelisk",layerName:"Obelisks",icon:"obelisk"},{name:"Library",layerName:"Libraries",icon:"library"},{name:"Mock",layerName:"Mocks",icon:"mock"},{name:"Portal",layerName:"Portals",icon:"portal"},{name:"DungeonPillar",layerName:"Dungeon Pillars",icon:"stop_available"},{name:"Altar",layerName:"Altars",icon:"altar"},{name:"Roost",layerName:"Roosts",icon:"mother_of_dragons"}],this.layerCatches=L.markerClusterGroup({maxClusterRadius:30}),this.layerPath=new L.LayerGroup,this.map=L.map(t,{layers:[e,this.layerCatches,this.layerPath]});var s={OpenStreetMap:e,OpenCycleMap:n,"OpenCycleMap Transport":i,Toner:a,Watercolor:o},r={Path:this.layerPath,Catches:this.layerCatches};this.layerBuildings=[],this.buildings=[];for(var l=0;l<this.buildingTypes.length;l++){this.buildings[l]=[];var c=new L.LayerGroup;c.addTo(this.map),r[this.buildingTypes[l].layerName]=c,this.layerBuildings.push(c)}L.control.layers(s,r).addTo(this.map),this.map.on("baselayerchange",function(t){var e=t.name;localStorage.setItem("layer",e)}.bind(this));var p=localStorage.getItem("layer");p&&$(".leaflet-control-layers-base span:contains('"+p+"')").first().prev().click(),this.map.on("singleclick",function(t){this.setDestination(t.latlng)}.bind(this)),this.path=null,this.route=null,this.destination=null,this.steps=[],this.catches=[],this.creatureList=[]};Map.prototype.saveContext=function(){sessionStorage.setItem("available",!0),sessionStorage.setItem("steps",JSON.stringify(this.steps)),sessionStorage.setItem("catches",JSON.stringify(this.catches))},Map.prototype.loadContext=function(){try{"true"==sessionStorage.getItem("available")&&(console.log("Load data from storage to restore session"),this.steps=JSON.parse(sessionStorage.getItem("steps"))||[],this.catches=JSON.parse(sessionStorage.getItem("catches"))||[],0<this.steps.length&&this.initPath(),this.initBuildings(),this.initCatches(),sessionStorage.setItem("available",!1))}catch(t){console.log(t)}},Map.prototype.initPath=function(){if(null!=this.path)return!0;if(!this.me){var t=this.steps[this.steps.length-1];this.map.setView([t.lat,t.lng],16),this.me=L.marker([t.lat,t.lng],{zIndexOffset:200}).addTo(this.map).bindPopup(t.lat.toFixed(4)+","+t.lng.toFixed(4)),$(".loading").hide()}if(2<=this.steps.length){var e=Array.from(this.steps,function(t){return L.latLng(t.lat,t.lng)});return this.path=L.polyline(e,{color:"red"}).addTo(this.layerPath),!0}return!1},Map.prototype.initCatches=function(){for(var t=0;t<this.catches.length;t++){var e=this.catches[t],n=e.fullname,i=L.icon({iconUrl:"./assets/creatures/"+n+".png",iconSize:[60,60],iconAnchor:[30,30]}),a=e.name+" <br /> Cp:"+e.cp+" Iv:"+e.iv+"%";e.lvl&&(a=e.name+" (lvl "+e.lvl+") <br /> Cp:"+e.cp+" Iv:"+e.iv+"%"),L.marker([e.lat,e.lng],{icon:i,zIndexOffset:100}).bindPopup(a).addTo(this.layerCatches)}},Map.prototype.initBuildings=function(){for(var t=0;t<this.buildingTypes.length;t++)for(var e=0;e<this.buildings[t].length;e++){var n=this.buildings[t][e],i=n.visited?"./assets/img/stop_visited.png":"./assets/img/"+this.buildingTypes[t].icon+".png",a=L.icon({iconUrl:i,iconSize:[30,30],iconAnchor:[15,15]});n.marker=L.marker([n.lat,n.lng],{icon:a,zIndexOffset:50}).bindPopup(n.name).addTo(this.layerBuildings[t])}},Map.prototype.addToPath=function(t){if(this.steps.push(t),global.config.memory.limit&&this.steps.length>global.config.memory.mathPath){this.layerPath.clearLayers(),this.path=null;var e=Math.floor(.7*global.config.memory.mathPath);this.steps=this.steps.slice(-e)}if(this.initPath()){var n=L.latLng(t.lat,t.lng);this.path.addLatLng(n),this.me.setLatLng(n).getPopup().setContent(t.lat.toFixed(4)+","+t.lng.toFixed(4)),global.config.followPlayer&&this.map.panTo(n,{animate:!0})}},Map.prototype.addCatch=function(t){if(!t.lat){if(this.steps.length<=0)return;var e=this.steps[this.steps.length-1];t.lat=e.lat,t.lng=e.lng}var n=t.display+"<br /> CP:"+t.cp;if(t.level&&(n=t.display+" (lvl "+t.level/2+") <br /> CP:"+t.cp),this.catches.push(t),global.config.memory.limit&&this.catches.length>global.config.memory.maxCaught){console.log("Clean catches");var i=Math.floor(.7*global.config.memory.maxCaught);this.catches=this.catches.slice(-i),this.layerCatches.clearLayers(),this.initCatches()}else{var a=t.fullname,o=L.icon({iconUrl:"./assets/creatures/"+a+".png",iconSize:[60,60],iconAnchor:[30,30]});L.marker([t.lat,t.lng],{icon:o,zIndexOffset:100}).bindPopup(n).addTo(this.layerCatches)}},Map.prototype.addVisitedBuilding=function(e){if(e.lat){var t=this.buildings[0].find(function(t){return t.id==e.id});if(t)Object.assign(t,e);else{this.buildings[0].push(e),t=e;var n=L.icon({iconUrl:"./assets/img/stop_cooldown.png",iconSize:[30,30],iconAnchor:[15,15]});e.marker=L.marker([e.lat,e.lng],{icon:n,zIndexOffset:50}).addTo(this.layerBuildings[0])}t.visited=!0,t&&t.marker&&(t.marker.setIcon(L.icon({iconUrl:"./assets/img/stop_cooldown.png",iconSize:[30,30],iconAnchor:[15,15]})),t.name?t.marker.bindPopup(t.name):t.marker.bindPopup(t.id))}},Map.prototype.addBuildings=function(t){for(var e=0;e<t.length;e++){var n=t[e],i=this.buildings[n.type].find(function(t){return t.id==n.id});i?n=Object.assign(i,n):this.buildings[n.type].push(n);var a=this.buildingTypes[n.type].icon;n.cooldown?a="stop_cooldown":n.visited&&(a="stop_visited");var o=n.arena?n.arena.allianceType:null;if(null!==o&&(a+=0===o?"_red":"_blue"),n.marker)n.marker.setIcon(L.icon({iconUrl:"./assets/img/"+a+".png",iconSize:[30,30],iconAnchor:[15,15]}));else{var s=L.icon({iconUrl:"./assets/img/"+a+".png",iconSize:[30,30],iconAnchor:[15,15]});n.marker=L.marker([n.lat,n.lng],{icon:s,zIndexOffset:50}).addTo(this.layerBuildings[n.type]),n.name?n.marker.bindPopup(n.name):n.marker.bindPopup(this.buildingTypes[n.type].name+"<br />"+n.id)}}},Map.prototype.setRoute=function(t){var e=Array.from(t,function(t){return L.latLng(t.lat,t.lng)});null!=this.route?this.route.setLatLngs(e):this.route=L.polyline(e,{dashArray:"5, 5",color:"red",opacity:.4}).addTo(this.layerPath)},Map.prototype.displayCreatureList=function(t,i,e){console.log("Creature list"),global.active="creature",console.log(t),this.creatureList=t||this.creatureList,this.eggsCount=e||this.eggsCount||0,i?localStorage.setItem("sortCreatureBy",i):i=localStorage.getItem("sortCreatureBy")||"cp",this.creatureList="name"===i?this.creatureList.sort(function(t,e){if(t[i]!=e[i])return t[i]-e[i];var n=e.cp!=t.cp?"cp":"iv";return e[n]-t[n]}):this.creatureList.sort(function(t,e){if(t[i]!=e[i])return e[i]-t[i];if(t.name!=e.name)return t.name-e.name;var n="cp"==i?"iv":"cp";return e[n]-t[n]});var n=this.eggsCount+this.creatureList.length;$(".inventory .numberinfo").text(n+"/"+global.storage.creatures);var c=$(".inventory .data");c.html(""),this.creatureList.forEach(function(t){var e=Object.keys(t.evolutions)[0],n=e&&t.improvable&&t.candies>=e&&!t.isArenaDefender,i=n?"":"hide",a=n?"canEvolve":"",o=t.isArenaDefender||t.isLibraryDefender||0<t.group?"hide":"",s=t.improvable&&e?"":"style='display:none'",r=Math.round(100*t.hp)/100,l=t.fullname;c.append('\n            <div class="pokemon '+(5<=t.attackValue&&5<=t.staminaValue?"perfect":"")+'">\n                <div class="transfer" data-id=\''+t.id+"'>\n                    <a title='Transfer' href=\"#\" class=\"transferAction "+o+'"><img src="./assets/img/recyclebin.png" /></a>\n                    <a title=\'Evolve\' href="#" class="evolveAction '+i+'"><img src="./assets/img/evolve.png" /></a>\n                </div>\n                <span class="imgspan '+a+'">\n                    <div class="stat atk">'+t.attackValue+'</div>\n                    <div class="stat stam">'+t.staminaValue+'</div>\n                    <div class="battle-type"><img src="./assets/img/'+(t.isAttacker?"Sword":"Shild")+'_color.png"/></div>\n                    <img src="./assets/creatures/'+l+'.png" />\n                </span>\n                <span class="name">'+t.display+" lvl "+t.level/2+'</span>\n                <span class="info">CP: <strong>'+t.cp+"</strong> IV: <strong>"+t.iv+'%</strong></span>\n                <span class="info">HP: '+r+'</span>\n                <span class="info">Candies: '+t.candies+"<span "+s+">/"+e+"</span></span>\n            </div>\n        ")}),$(".pokemonsort").show(),$(".inventory").show().addClass("active")},Map.prototype.displayEggsList=function(t,e){console.log("Eggs list"),global.active="eggs",$(".inventory .sort").hide(),$(".inventory .numberinfo").text(t.length+"/"+e);var a=$(".inventory .data");a.html(""),t.forEach(function(t){if(t){var e=t.eggType,n=(t.passedDistance/1e3).toFixed(1)+" / "+(t.totalDistance/1e3).toFixed(1)+" km";t.isEggForRoost&&(n=t.passedDistance.toFixed(1)+" / "+t.totalDistance.toFixed(1)+" h");var i="./assets/inventory/"+e+".png";null!==t.incubatorId&&(i="./assets/img/cocoon.png",t.isEggForRoost&&(i="./assets/img/mod_cocoon.png")),a.append('\n                <div class="egg">\n                    <span class="imgspan"><img src="'+i+'" /></span>\n                    <span>'+n+"</span>\n                </div>\n            ")}}),$(".inventory").show().addClass("active")},Map.prototype.displayInventory=function(t){console.log("Inventory list"),global.active="inventory",$(".inventory .sort").hide();var e=t.reduce(function(t,e){return t+e.count},0);$(".inventory .numberinfo").text(e+"/"+global.storage.items);var i=$(".inventory .data");i.html(""),t.forEach(function(t){var e=t.removable?"":"hide",n=0<=["INCENSE","SUPER_VISION","EXPERIENCE_BOOSTER"].indexOf(t.fulltype)?"":"hide";i.append('\n            <div class="item">\n                <div class="transfer" data-id=\''+t.type+"' data-count='"+t.count+"'>\n                    <a title='Use' href=\"#\" class=\"useItemAction "+n+'"><img src="./assets/img/use.png" /></a>\n                    <a title=\'Drop\' href="#" class="dropItemAction '+e+'"><img src="./assets/img/recyclebin.png" /></a>\n                </div>\n\n                <span class="count">x'+t.count+'</span>\n                <span class="imgspan"><img src="./assets/inventory/'+t.type+'.png" /></span>\n                <span class="info">'+t.display+"</span>\n            </div>\n        ")}),$(".inventory").show().addClass("active")},Map.prototype.setDestination=function(t){var e=L.popup().setLatLng(t).setContent("<div class='dest'>"+t.lat.toFixed(6)+", "+t.lng.toFixed(6)+'</div><div class="center-align"><a class="destBtn waves-effect waves-light btn">Go?</a></div>').openOn(this.map);$(".destBtn").click(function(){this.map.closePopup(e),console.log("Set destination: "+t.lat+", "+t.lng),this.destination&&this.layerPath.removeLayer(this.destination),this.destination=L.marker(t,{zIndexOffset:199,icon:new RedIcon}).bindPopup(t.lat+", "+t.lng).addTo(this.layerPath),global.ws.emit("set_destination",t)}.bind(this))},Map.prototype.manualDestinationReached=function(){this.layerPath.removeLayer(this.destination),this.destination=null};var RedIcon=L.Icon.Default.extend({options:{iconUrl:"assets/img/marker-icon-red.png"}});function setUserName(t){global.user||(global.user=t,document.title="["+t+"] "+document.title)}function startTimers(){window.setInterval(function(){global.connected&&global.ws.emit("player_stats")},3e5)}function startListenToSocket(){console.log("Connecting to "+global.config.websocket),startTimers();var t=localStorage.getItem("pokemonSettings");global.pokemonSettings=t?JSON.parse(t):{};var e=io(global.config.websocket,{transports:["websocket","polling"]});(global.ws=e).on("connect",function(){console.log("Connected to Bot"),global.connected=!0,$(".loading").text("Waiting to get GPS coordinates from client...")}),e.on("disconnect",function(){global.connected=!1}),e.on("initialized",function(t){t.username&&(console.log("Bot Ready."),console.log(t),setUserName(t.username),global.player=t.player,global.player&&($(".player").trigger("pogo:player_update"),gtag("event","level",global.player.level)),global.storage=t.storage,global.map.addToPath(t.pos)),$(".toolbar div").show(),global.ws.emit("pokemon_settings")}),e.on("pokemon_settings",function(t){global.pokemonSettings=t,localStorage.setItem("pokemonSettings",JSON.stringify(global.pokemonSettings))}),e.on("player_stats",function(t){global.player=t.player,$(".player").trigger("pogo:player_update")}),e.on("position",function(t){global.snipping||global.map.addToPath(t)}),e.on("buildings",function(t){console.log("Update Buildings");t=Array.from(t.filter(function(t){return 0<=t.type&&t.type<=8}),function(t){return{id:t.id,type:t.type,lat:t.coords.latitude,lng:t.coords.longitude,cooldown:t.pitstop?t.pitstop.cooldown:null,lureExpire:!1,arena:t.arena}});global.map.addBuildings(t)}),e.on("building_visited",function(t){console.log("Building Visited"),global.map.addVisitedBuilding({id:t.id,name:"",lat:t.coords.latitude,lng:t.coords.longitude,cooldown:t.pitstop.cooldown,visited:!0})}),e.on("creature_caught",function(t){console.log("Creature caught"),console.log(t);var e=t.creature;t.position&&(e.lat=t.position.lat,e.lng=t.position.lng),global.map.addCatch(e),creatureToast(e,{ball:e.ball})}),e.on("creature_evolved",function(t){creatureToast({id:t.evolution,name:t.from.display},{title:"A "+t.from.display+" evolved"})}),e.on("inventory_list",function(t){console.log(t),global.map.displayInventory(t)}),e.on("creature_list",function(e){console.log(e);var t=e.creatures.map(function(t){return t.iv=10*(t.attackValue+t.staminaValue),t.candies=e.candies[t.candyType],t});global.map.displayCreatureList(t,null,e.eggs_count)}),e.on("eggs_list",function(t){console.log(t),global.map.displayEggsList(t.eggs,t.max)}),e.on("route",function(t){global.map.setRoute(t)}),e.on("manual_destination_reached",function(){global.map.manualDestinationReached()}),global.ws=e}function errorToast(t){toastr.error(t,"Error",{progressBar:!0,positionClass:"toast-top-right",timeOut:"5000",closeButton:!0})}function creatureToast(t,e){if(!global.config.noPopup){var n=(e=e||{}).title||(global.snipping?"Snipe success":"Catch success"),i=global.snipping?toastr.success:toastr.info,a=t.display;t.level&&(a+=" (lvl "+t.level+")");var o="<div>"+a+"</div><div>";o+="<img src='./assets/creatures/"+t.fullname+".png' height='50' />",e.ball&&(o+="<img src='./assets/inventory/"+e.ball+".png' height='30' />"),i(o+="</div>",n,{progressBar:!0,positionClass:"toast-top-right",timeOut:5e3,closeButton:!0})}}L.MarkerCluster.prototype.true_initialize=L.MarkerCluster.prototype.initialize,L.MarkerCluster.prototype.initialize=function(t,e,n,i){this.true_initialize(t,e,n,i),this.setZIndexOffset(200)},L.Evented.addInitHook(function(){this._singleClickTimeout=null,this.on("click",this._scheduleSingleClick,this),this.on("dblclick dragstart zoomstart",this._clearSingleClickTimeout.bind(this),this)}),L.Evented.include({_scheduleSingleClick:function(t){this._clearSingleClickTimeout(),this._singleClickTimeout=setTimeout(this._fireSingleClick.bind(this,t),500)},_fireSingleClick:function(t){t.originalEvent._stopped||this.fire("singleclick",L.Util.extend(t,{type:"singleclick"}))},_clearSingleClickTimeout:function(){null!=this._singleClickTimeout&&(clearTimeout(this._singleClickTimeout),this._singleClickTimeout=null)}}),function(){var g={storage:{items:350,creatures:250},snipping:!1};function s(t,e){g.config.noConfirm?e():vex.dialog.confirm({unsafeMessage:t,callback:function(t){t&&e()}})}(window.global=g).config=window.configService.load(),g.version=g.config.version,document.title+=" - "+g.version,$(function(){!function(){window.gtag=window.gtag||function(){};var t=localStorage.getItem("sortCreatureBy")||"cp";$("#sortBy"+t).addClass("active").siblings().removeClass("active"),$("#pokemonLink").click(function(){"1"==$(".inventory").css("opacity")&&$(".inventory .data .pokemon").length?$(".inventory").removeClass("active"):g.ws.emit("creature_list")}),$("#eggsLink").click(function(){"1"==$(".inventory").css("opacity")&&$(".inventory .data .egg").length?$(".inventory").removeClass("active"):g.ws.emit("eggs_list")}),$("#inventoryLink").click(function(){"1"==$(".inventory").css("opacity")&&$(".inventory .data .item").length?$(".inventory").removeClass("active"):g.ws.emit("inventory_list")}),$("#sortBypokemonId").click(function(){return g.map.displayCreatureList(null,"name")}),$("#sortBycp").click(function(){return g.map.displayCreatureList(null,"cp")}),$("#sortByiv").click(function(){return g.map.displayCreatureList(null,"iv")}),$("#sortBypokemonId, #sortBycp, #sortByiv").click(function(){$(this).hasClass("active")||$(this).toggleClass("active").siblings().removeClass("active")}),$(".inventory .refresh").click(function(){console.log("Refresh"),g.ws.emit(g.active+"_list")}),$(".inventory .close").click(function(){$(this).parent().removeClass("active"),$(".inventory .sort").hide()}),$(".message .close").click(function(){$(this).parent().hide()}),$(".close").click(function(){g.active=null}),$("#recycleLink").click(function(){sessionStorage.setItem("available",!1),window.location.reload()}),$("#settingsLink").click(function(){g.map.saveContext(),window.location="config.html"}),$(".inventory .data").on("click","a.transferAction",function(t){t.preventDefault();var e=$(this).parent(),n=e.data().id,i=g.map.creatureList.findIndex(function(t){return t.id==n}),a=g.map.creatureList[i],o=g.map.creatureList.filter(function(t){return t.name==a.name}).length-1;s("Are you sure you want to transfer this "+a.display+"? <br /> You will have <b>"+o+"</b> left.",function(){gtag("event","transfer",a.display),g.ws.emit("transfer_creature",{id:n}),g.map.creatureList.splice(i,1),e.parent().fadeOut()})}),$(".inventory .data").on("click","a.evolveAction",function(t){t.preventDefault();var r=$(this).parent(),l=r.data().id,c=g.map.creatureList.findIndex(function(t){return t.id==l}),p=g.map.creatureList[c],e=g.map.creatureList.filter(function(t){return t.name==p.name}).length-1;s("Are you sure you want to evolve this "+p.display+"? <br /> You will have <b>"+e+"</b> left.",function(){gtag("event","evolve",name),console.log("Evolve "+l);var t=Object.values(p.evolutions)[0];g.ws.emit("evolve_creature",{id:l,to:Object.values(p.evolutions)[0]}),g.map.creatureList.splice(c,1);var e=!0,n=!1,i=void 0;try{for(var a,o=g.map.creatureList[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){var s=a.value;s.candyType===p.candyType&&(s.candies-=t)}}catch(t){n=!0,i=t}finally{try{!e&&o.return&&o.return()}finally{if(n)throw i}}r.parent().fadeOut()})}),$(".inventory .data").on("click","a.favoriteAction",function(t){t.preventDefault();var e=$(this).parent(),n=e.data().id,i=g.map.creatureList.findIndex(function(t){return t.id==n}),a=g.map.creatureList[i];a.favorite=!a.favorite;var o=a.display;gtag("event","favorite",o),$(this).find("img").attr("src","./assets/img/favorite_"+(a.favorite?"set":"unset")+".png"),e.find(".transferAction").toggleClass("hide"),g.ws.emit("favorite_creature",{id:n,favorite:a.favorite})}),$(".inventory .data").on("click","a.useItemAction",function(t){t.preventDefault();var e=$(this).parent(),n=e.data().id,i=e.parent().find(".info").text(),a=e.data().count;gtag("event","use_item",i),g.ws.emit("use_item",{id:n}),a--,console.log("Use item "+i+", "+a+" left"),0===a?e.parent().fadeOut():(e.data("count",a),e.parent().find(".count").text("x"+a))}),$(".inventory .data").on("click","a.dropItemAction",function(t){t.preventDefault();var n=$(this).parent(),i=n.data().id,a=n.parent().find(".info").text(),o=n.data().count;vex.dialog.confirm({unsafeMessage:"How many <b>"+a+"</b> would you like to drop?",input:'\n                    <p class="range-field">\n                        <input type="range" name="count" value="1" min="1" max="'+o+"\" onchange=\"$('#display-range').text(this.value)\" />\n                    </p>\n                    Drop: <span id='display-range'>1</span>\n                ",callback:function(t){if(t){var e=parseInt(t.count);gtag("event","drop_items",a),g.ws.emit("drop_items",{id:i,count:e}),o==e?n.parent().fadeOut():(n.data("count",o-e),n.parent().find(".count").text("x"+(o-e)))}}})}),$(".player").on("pogo:player_update",function(){if(g.player){var t=$(".player");t.find(".playername .value").text(g.user),t.find(".level .value").text(g.player.level);var e=100*g.player.currentExperience/g.player.nextLevelExperience;t.find(".myprogress .value").css("width",e.toFixed(0)+"%"),t.show()}}),g.config.websocket?(g.map=new Map("map"),g.map.loadContext(),startListenToSocket()):window.location="config.html"}()})}();